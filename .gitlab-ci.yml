# GitLab CI/CD Pipeline –¥–ª—è BNF Parser

variables:
  BUILD_TYPE: "debug"
  CXX_STANDARD: "17"
  NINJA_JOBS: "4"

stages:
  - lint
  - build
  - test
  - release

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
cache:
  paths:
    - out/
    - .gn/

# –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
.base_image: &base_image
  image: ubuntu:22.04
  before_script:
    - apt-get update
    - apt-get install -y build-essential ninja-build git curl
    - |
      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ GN
      curl -L https://chrome-infra-packages.appspot.com/dl/gn/gn/linux-amd64/+/latest -o gn.zip
      unzip gn.zip
      mv gn /usr/local/bin/
      gn --version

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
lint:
  <<: *base_image
  stage: lint
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞..."
    - |
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞
      find src include -name "*.cpp" -o -name "*.hpp" | head -10
    - |
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–º–º–∏—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è push)
      if [ "$CI_PIPELINE_SOURCE" = "push" ]; then
        git log --format="%s" -1 | grep -E "^(feat|fix|docs|style|refactor|test|build|chore)(\(.+\))?: .+" || {
          echo "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–º–∏—Ç–∞"
          exit 1
        }
        echo "‚úÖ –§–æ—Ä–º–∞—Ç –∫–æ–º–º–∏—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
      fi
    - echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# –°–±–æ—Ä–∫–∞ Debug
build:debug:
  <<: *base_image
  stage: build
  script:
    - echo "üî® –°–±–æ—Ä–∫–∞ Debug –≤–µ—Ä—Å–∏–∏..."
    - |
      # –°–æ–∑–¥–∞–µ–º args.gn –¥–ª—è debug —Å–±–æ—Ä–∫–∏
      mkdir -p out/debug
      cat > out/debug/args.gn << EOF
      is_debug = true
      bnf_parser_enable_unicode = true
      bnf_parser_enable_tests = true
      bnf_parser_enable_examples = true
      EOF
    - gn gen out/debug
    - ninja -C out/debug all -j$NINJA_JOBS
    - echo "‚úÖ Debug —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
  artifacts:
    paths:
      - out/debug/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# –°–±–æ—Ä–∫–∞ Release
build:release:
  <<: *base_image
  stage: build
  script:
    - echo "üî® –°–±–æ—Ä–∫–∞ Release –≤–µ—Ä—Å–∏–∏..."
    - |
      # –°–æ–∑–¥–∞–µ–º args.gn –¥–ª—è release —Å–±–æ—Ä–∫–∏
      mkdir -p out/release
      cat > out/release/args.gn << EOF
      is_debug = false
      bnf_parser_enable_unicode = true
      bnf_parser_enable_tests = true
      bnf_parser_enable_examples = true
      EOF
    - gn gen out/release
    - ninja -C out/release all -j$NINJA_JOBS
    - echo "‚úÖ Release —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
  artifacts:
    paths:
      - out/release/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "tag"

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test:debug:
  <<: *base_image
  stage: test
  dependencies:
    - build:debug
  script:
    - echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
    - |
      # –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤
      if [ -f "out/debug/basic_test" ]; then
        echo "–ó–∞–ø—É—Å–∫ basic_test..."
        out/debug/basic_test
      fi
    - |
      # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
      if [ -f "out/debug/simple_demo" ]; then
        echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ simple_demo..."
        out/debug/simple_demo || true
      fi
    - |
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º
      for debug_prog in out/debug/debug_*; do
        if [ -f "$debug_prog" ] && [ -x "$debug_prog" ]; then
          echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ $(basename $debug_prog)..."
          $debug_prog || true
        fi
      done
    - echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DCO
dco:check:
  <<: *base_image
  stage: test
  script:
    - echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ DCO..."
    - |
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–º–º–∏—Ç—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã
      git log --format='%H %s' -1 | grep -q 'Signed-off-by:' || {
        echo "‚ùå –ö–æ–º–º–∏—Ç –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω"
        exit 1
      }
      echo "‚úÖ DCO –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞
release:
  <<: *base_image
  stage: release
  dependencies:
    - build:release
  script:
    - echo "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞..."
    - |
      # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å —Ä–µ–ª–∏–∑–æ–º
      mkdir -p artifacts
      cp -r out/release/* artifacts/ 2>/dev/null || true
      cp -r docs/ artifacts/ 2>/dev/null || true
      cp README.md artifacts/ 2>/dev/null || true
    - |
      # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤
      VERSION=${CI_COMMIT_TAG:-$(git describe --tags --abbrev=0 2>/dev/null || echo "dev")}
      tar -czf bnf-parser-${VERSION}.tar.gz artifacts/
      ls -la *.tar.gz
    - echo "‚úÖ –†–µ–ª–∏–∑ —Å–æ–∑–¥–∞–Ω"
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: never
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π release
auto:release:
  <<: *base_image
  stage: release
  script:
    - echo "ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π release..."
    - |
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–µ–Ω –ª–∏ release
      LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
      COMMITS_SINCE_TAG=$(git log --oneline $LAST_TAG..HEAD 2>/dev/null || git log --oneline)
      
      if echo "$COMMITS_SINCE_TAG" | grep -q "feat:\|fix:\|BREAKING CHANGE:"; then
        echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã –∫–æ–º–º–∏—Ç—ã, —Ç—Ä–µ–±—É—é—â–∏–µ release"
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ release
        # –ù–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ –∏ —Ä–µ–ª–∏–∑–∞
      else
        echo "‚ÑπÔ∏è –ù–µ—Ç –∫–æ–º–º–∏—Ç–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö release"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"

# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
notify:success:
  stage: release
  script:
    - echo "‚úÖ Pipeline —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω"
    - echo "–í—Ä–µ–º—è: $(date)"
    - echo "–ö–æ–º–º–∏—Ç: $CI_COMMIT_SHA"
    - echo "–í–µ—Ç–∫–∞: $CI_COMMIT_REF_NAME"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
  when: on_success

notify:failure:
  stage: release
  script:
    - echo "‚ùå Pipeline –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
    - echo "–í—Ä–µ–º—è: $(date)"
    - echo "–ö–æ–º–º–∏—Ç: $CI_COMMIT_SHA"
    - echo "–í–µ—Ç–∫–∞: $CI_COMMIT_REF_NAME"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
  when: on_failure
